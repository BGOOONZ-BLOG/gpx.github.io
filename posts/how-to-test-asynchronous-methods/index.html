<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/styles.0c580d23d0cef08712c6.css">article{margin:4em 0;text-align:justify;-webkit-hyphens:auto;-ms-hyphens:auto;hyphens:auto;hyphenate-limit-chars:6 3 2;hyphenate-limit-lines:2;hyphenate-limit-last:always;-webkit-text-decoration-skip:ink;text-decoration-skip-ink:auto}article h1{font-size:1.5rem;margin:3em 0;text-align:center;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}article h2{text-align:left;font-size:1.3rem;margin:2em 0 1em}article p:first-child:first-line{font-weight:600}article a{text-decoration:underline}article figure{margin:auto auto 3em;text-align:center}article img{max-width:100%}article figcaption{text-align:center;font-style:italic;border-bottom:1px solid rgba(0,0,0,.67)}hr{border:none;border-radius:50%;margin:2em auto}hr,hr:after,hr:before{height:3px;width:3px;background:rgba(0,0,0,.67)}hr:after,hr:before{position:absolute;content:"";display:inline-block;border-radius:50%;padding:0}hr:before{-webkit-transform:translateX(-1em);transform:translateX(-1em)}hr:after{-webkit-transform:translateX(1em);transform:translateX(1em)}article .highlight{text-align:left;-webkit-hyphens:initial;-ms-hyphens:initial;hyphens:manual;font-size:1.3em;color:#666;margin:1.7em;font-weight:100;padding-bottom:.5em;border-bottom:3px solid #3f51b5}article ul{text-align:left;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}article li{margin-bottom:.5em}details.tldr{border:1px solid rgba(0,0,0,.2);padding:.4em 1em;margin-bottom:4rem}details summary{cursor:pointer}twitter-widget{margin:2em auto!important}blockquote{text-align:left;-webkit-hyphens:initial;-ms-hyphens:initial;hyphens:manual;margin:2em auto;max-width:80%;font-size:1.2em;font-style:italic}blockquote p:first-child:first-line{font-weight:400}*,:after,:before{box-sizing:border-box}::-moz-selection,:not(pre) code[class*=language-]::-moz-selection{background:rgba(3,169,244,.2)}::selection,:not(pre) code[class*=language-]::selection{background:rgba(3,169,244,.2)}html{font-size:19px}body{font-family:EB Garamond,Palatino,Palatino Linotype,Palatino LT STD,Book Antiqua,Georgia,serif;color:#333;line-height:1.5;margin:0}a{text-decoration:none;color:currentColor}code[class*=language-],pre[class*=language-]{font-family:Ubuntu Mono,monospace;font-size:.9em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}code[class*=language-]::-moz-selection,code[class*=language-] ::-moz-selection,pre[class*=language-]::-moz-selection,pre[class*=language-] ::-moz-selection{background:hsla(0,0%,100%,.13)}code[class*=language-]::selection,code[class*=language-] ::selection,pre[class*=language-]::selection,pre[class*=language-] ::selection{background:hsla(0,0%,100%,.13)}pre[class*=language-]{padding:1em;margin:0 0 .5em;overflow:auto}:not(pre)>code[class*=language-],pre[class*=language-]{background:#1e272e;border-radius:0 0 .5em .5em;color:#d2dae2}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal;background:rgba(0,0,0,.07);color:inherit}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#808e9b;font-style:italic}.token.punctuation{color:#808e9b}.namespace{color:red;background:red}.token.boolean,.token.constant,.token.deleted,.token.number,.token.property,.token.symbol,.token.tag{color:#ffa801}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string{color:#0be881}.language-css .token.string,.style .token.string,.token.entity,.token.operator,.token.url{color:#ffd32a}.token.atrule,.token.attr-value,.token.keyword{color:#ef5777}.token.class-name,.token.function{color:#0fbcf9}.token.important,.token.regex,.token.variable{color:red;background:red}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}.gatsby-highlight-code-line{background:#2f3d48;display:block;margin-right:-1em;margin-left:-1em;padding-right:1em;padding-left:.75em;border-left:.25em solid #575fcf}.gatsby-highlight:before{content:attr(data-language);display:block;padding:.3em 1em;font-size:.9em;text-transform:uppercase;text-align:right;background-image:-webkit-gradient(linear,left top,right top,from(#7986cb),to(#3f51b5));background-image:linear-gradient(90deg,#7986cb,#3f51b5);color:#fff;font-family:Ubuntu Mono,monospace;border-radius:.5em .5em 0 0}.gatsby-highlight[data-language=html]:before{background-image:-webkit-gradient(linear,left top,right top,from(#ffb74d),to(#ff9800));background-image:linear-gradient(90deg,#ffb74d,#ff9800)}.gatsby-highlight[data-language=text]:before{content:" ";white-space:pre;background-image:-webkit-gradient(linear,left top,right top,from(#dce775),to(#cddc39));background-image:linear-gradient(90deg,#dce775,#cddc39)}.gatsby-highlight{border-radius:.5em;box-shadow:2px 2px 3px 2px rgba(0,0,0,.2);margin:2em 0}</style><meta name="generator" content="Gatsby 2.8.5"/><style data-styled="kFBkna jOppYm fzeAzQ dFUOyp gyqfWo ddOZgs ioFzeH" data-styled-version="4.3.1">
/* sc-component-id: header__Title-w0084c-0 */
.kFBkna{margin-bottom:2.5em;display:block;font-weight:500;font-size:2rem;text-align:center;padding:2em 0;color:#fff;text-shadow:1px 0 1px #0004;-webkit-text-decoration:none;text-decoration:none;width:100%;background:#3a6;}
/* sc-component-id: footer__Container-sc-1abtvul-0 */
.gyqfWo{margin-top:4em;padding:3em 0;text-align:right;background:#3a6;color:#fff;text-shadow:1px 0 1px #0004;}
/* sc-component-id: footer__Content-sc-1abtvul-1 */
.ddOZgs{max-width:calc(65 * 9px);margin:auto;} .ddOZgs > *{margin:0.7em;} .ddOZgs > *:first-child{margin-left:0;} .ddOZgs > *:last-child{margin-right:0;}
/* sc-component-id: footer__Copy-sc-1abtvul-2 */
.ioFzeH{max-width:calc(65 * 9px);margin:auto;font-size:0.85em;margin-top:1em;}
/* sc-component-id: layout__Container-sc-4dh0yk-0 */
.jOppYm{max-width:calc(65 * 9px);margin:auto;}
/* sc-component-id: blog-post__Meta-sc-7gkdnd-0 */
.fzeAzQ{display:block;font-size:0.65em;font-weight:400;color:#666;margin-top:0.5em;}
/* sc-component-id: blog-post__Footer-sc-7gkdnd-1 */
.dFUOyp{font-size:0.85rem;text-align:center;margin-bottom:3rem;padding:0.5em 0;background:#e8eaf6;} .dFUOyp a{-webkit-text-decoration:underline;text-decoration:underline;}</style><link rel="preload" as="font" type="font/woff2" crossorigin="anonymous" href="/google-fonts/s/ebgaramond/v10/SlGJmQSNjdsmc35JDF1K5GyGaywSQg4.woff2"/><link rel="preload" as="font" type="font/woff2" crossorigin="anonymous" href="/google-fonts/s/ebgaramond/v10/SlGJmQSNjdsmc35JDF1K5GyqbCwSQg4.woff2"/><link rel="preload" as="font" type="font/woff2" crossorigin="anonymous" href="/google-fonts/s/ebgaramond/v10/SlGLmQSNjdsmc35JDF1K5GRwcMgWcgzoqA.woff2"/><link rel="preload" as="font" type="font/woff2" crossorigin="anonymous" href="/google-fonts/s/ebgaramond/v10/SlGUmQSNjdsmc35JDF1K5GR1SDk.woff2"/><link rel="preload" as="font" type="font/woff2" crossorigin="anonymous" href="/google-fonts/s/ebgaramond/v10/SlGWmQSNjdsmc35JDF1K5GRweDs1Zw.woff2"/><link rel="preload" as="font" type="font/woff2" crossorigin="anonymous" href="/google-fonts/s/ubuntumono/v8/KFOjCneDtsqEr0keqCMhbCc6CsQ.woff2"/><style type="text/css">@font-face{font-family:'EB Garamond';font-style:italic;font-weight:400;src:local('EB Garamond Italic'),local('EBGaramond-Italic'),url(/google-fonts/s/ebgaramond/v10/SlGWmQSNjdsmc35JDF1K5GRweDs1Zw.woff2) format('woff2'),url(/google-fonts/s/ebgaramond/v10/SlGWmQSNjdsmc35JDF1K5GRweDs1YQ.woff) format('woff');font-display: swap;}@font-face{font-family:'EB Garamond';font-style:italic;font-weight:500;src:local('EB Garamond Medium Italic'),local('EBGaramond-MediumItalic'),url(/google-fonts/s/ebgaramond/v10/SlGLmQSNjdsmc35JDF1K5GRwcMgWcgzoqA.woff2) format('woff2'),url(/google-fonts/s/ebgaramond/v10/SlGLmQSNjdsmc35JDF1K5GRwcMgWcgzorg.woff) format('woff');font-display: swap;}@font-face{font-family:'EB Garamond';font-style:normal;font-weight:400;src:local('EB Garamond Regular'),local('EBGaramond-Regular'),url(/google-fonts/s/ebgaramond/v10/SlGUmQSNjdsmc35JDF1K5GR1SDk.woff2) format('woff2'),url(/google-fonts/s/ebgaramond/v10/SlGUmQSNjdsmc35JDF1K5GR1SD8.woff) format('woff');font-display: swap;}@font-face{font-family:'EB Garamond';font-style:normal;font-weight:500;src:local('EB Garamond Medium'),local('EBGaramond-Medium'),url(/google-fonts/s/ebgaramond/v10/SlGJmQSNjdsmc35JDF1K5GyGaywSQg4.woff2) format('woff2'),url(/google-fonts/s/ebgaramond/v10/SlGJmQSNjdsmc35JDF1K5GyGaywSQgg.woff) format('woff');font-display: swap;}@font-face{font-family:'EB Garamond';font-style:normal;font-weight:600;src:local('EB Garamond SemiBold'),local('EBGaramond-SemiBold'),url(/google-fonts/s/ebgaramond/v10/SlGJmQSNjdsmc35JDF1K5GyqbCwSQg4.woff2) format('woff2'),url(/google-fonts/s/ebgaramond/v10/SlGJmQSNjdsmc35JDF1K5GyqbCwSQgg.woff) format('woff');font-display: swap;}@font-face{font-family:'Ubuntu Mono';font-style:normal;font-weight:400;src:local('Ubuntu Mono'),local('UbuntuMono-Regular'),url(/google-fonts/s/ubuntumono/v8/KFOjCneDtsqEr0keqCMhbCc6CsQ.woff2) format('woff2'),url(/google-fonts/s/ubuntumono/v8/KFOjCneDtsqEr0keqCMhbCc6CsI.woff) format('woff');font-display: swap;}</style><link rel="preconnect dns-prefetch" href="https://www.google-analytics.com"/><link rel="alternate" type="application/rss+xml" href="/rss.xml"/><link as="script" rel="preload" href="/webpack-runtime-abed6febe877bdf6f217.js"/><link as="script" rel="preload" href="/app-8f0c61b713fc20007cc1.js"/><link as="script" rel="preload" href="/styles-f1e3bcc8236c344d8830.js"/><link as="script" rel="preload" href="/1-028385e9f855bc3dfe2e.js"/><link as="script" rel="preload" href="/component---src-templates-blog-post-js-55aa70a957a750bead14.js"/><link as="fetch" rel="preload" href="/static/d/726/path---posts-how-to-test-asynchronous-methods-bbc-b9b-jVaooB9j2Lq1FOyVwEgTHZK1IdI.json" crossorigin="use-credentials"/></head><body><noscript id="gatsby-noscript">This app works best with JavaScript enabled.</noscript><div id="___gatsby"><div style="outline:none" tabindex="-1" role="group"><a class="header__Title-w0084c-0 kFBkna" href="/">Giorgio Polvara&#x27;s Blog</a><div class="layout__Container-sc-4dh0yk-0 jOppYm"><article lang="en"><h1><span>How to Test Asynchronous Methods</span><span class="blog-post__Meta-sc-7gkdnd-0 fzeAzQ">May 19, 2019<!-- --> · <!-- -->6<!-- --> min read</span></h1><div><p>I continue my series of posts on <code class="language-text">react-testing-library</code> this time with a brief
explanation on how to test asynchronous methods. The idea for this post comes
from a person who contacted me on Twitter asking this:</p>
<blockquote>
<p>[...] how would one test async methods loaded during <code class="language-text">componentdidMount</code>?</p>
</blockquote>
<p>In my personal experience 99% of the time an async method is going to fetch some
data from the server. This is especially true if we call this method from
<code class="language-text">componentDidMount</code>. You can then understand how important it is to know how to
test these methods properly.</p>
<p>Two notes before I start:</p>
<ul>
<li>The question is about methods called in <code class="language-text">componentDidMount</code> but the testing
strategy is the same if you use Hooks;</li>
<li>If you are uncertain how to make asynchronous calls in the first place check
my other post
<a href="fetching-asynchronous-data-with-react-hooks">Fetching Asynchronous Data with React Hooks</a>.</li>
</ul>
<hr>
<p>There are two things you want to test when it comes to asynchronous methods. The
first is that the method itself got called and with the right parameters. The
second is that after the call your application responds as it should. Let's see
what this means in practice.</p>
<p>Imagine you have a small blog application written in React. In particular you
have an <code class="language-text">Index</code> component that shows the list of posts—kinda like what I have in
<a href="/">my homepage</a>.</p>
<p><code class="language-text">Index</code> will probably look something like this:</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="language-jsx"><code class="language-jsx"><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">"react"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> fetchPosts <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./api/posts"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> useAsync <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"react-use"</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">Index</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> posts <span class="token operator">=</span> <span class="token function">useAsync</span><span class="token punctuation">(</span>fetchPosts<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>posts<span class="token punctuation">.</span>loading<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token string">"Loading..."</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>posts<span class="token punctuation">.</span>error<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token string">"Something went wrong."</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span></span><span class="token punctuation">></span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">></span></span><span class="token plain-text">My Posts</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">></span></span><span class="token plain-text">
        </span><span class="token punctuation">{</span>posts<span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">post</span> <span class="token operator">=></span> <span class="token punctuation">(</span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">key</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>post<span class="token punctuation">.</span>id<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">
            </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>post<span class="token punctuation">.</span>url<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token punctuation">{</span>post<span class="token punctuation">.</span>title<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span><span class="token plain-text">
          </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span>
        <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">></span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span></span><span class="token punctuation">></span></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p>You have probably seen code like this before and maybe even written some
yourself. Here we're fetching a list of posts via the <code class="language-text">fetchPosts</code> method. We're
showing a loading message while this happens. Once the async method resolves, we
either show an error or the list of posts.</p>
<p>If you are confused by the <code class="language-text">useAsync</code> call refer to my
<a href="fetching-asynchronous-data-with-react-hooks">previous post</a> where I explain how
it works.</p>
<p>If you prefer to avoid Hooks, this is the class implementation (note that the
tests we're going to write are going to work with both implementations):</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="language-jsx"><code class="language-jsx"><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">"react"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> fetchPosts <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./api/posts"</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Index</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
  state <span class="token operator">=</span> <span class="token punctuation">{</span> loading<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> error<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> posts<span class="token punctuation">:</span> <span class="token keyword">null</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">async</span> <span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> loading<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> posts <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetchPosts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> loading<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> posts <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> loading<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> error <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>loading<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token string">"Loading..."</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>error<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token string">"Something went wrong."</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span></span><span class="token punctuation">></span></span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">></span></span><span class="token plain-text">My Posts</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">></span></span><span class="token plain-text">
          </span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>posts<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">post</span> <span class="token operator">=></span> <span class="token punctuation">(</span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">key</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>post<span class="token punctuation">.</span>id<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">
              </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>post<span class="token punctuation">.</span>url<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token punctuation">{</span>post<span class="token punctuation">.</span>title<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span><span class="token plain-text">
            </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span>
          <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">></span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span></span><span class="token punctuation">></span></span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>A bit longer to type but it does the same thing the Hook version does.</p>
<p>Now to the tests!</p>
<hr>
<p>The first thing we want to do is to mock the API calls. Why? I can give you two
good reasons for this. The first one is that it will make our tests more
reliable. If your test fetched the list of posts, it would need a server to
call. This server might or might not be working making our tests failing
randomly.</p>
<p>The second reason is speed. Performing a real API call takes time. It might not
seem like much when you have just one test but as your codebase grows the
slowness will show.</p>
<p>So, how do we mock the API call? In our case, the call happens in the
<code class="language-text">fetchPosts</code> method so we can mock it:</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="language-jsx"><code class="language-jsx">jest<span class="token punctuation">.</span><span class="token function">mock</span><span class="token punctuation">(</span><span class="token string">"./api/posts"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>You can read more about <code class="language-text">jest.mock</code> in the
<a href="https://jestjs.io/docs/en/jest-object#jestmockmodulename-factory-options" target="_blank" rel="nofollow noopener noreferrer">official docs</a>.
What it does is to tell Jest to replace all the methods inside the <code class="language-text">./api/posts</code>
module with a mock.</p>
<p>Now that we have the mock in place let's render the component and test that we
see a loading message:</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="language-jsx"><code class="language-jsx"><span class="gatsby-highlight-code-line"><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">"react"</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line"><span class="token keyword">import</span> <span class="token punctuation">{</span> render <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"@testing-library/react"</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line"><span class="token keyword">import</span> Index <span class="token keyword">from</span> <span class="token string">"./Index"</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line"><span class="token keyword">import</span> <span class="token string">"jest-dom/extend-expect"</span><span class="token punctuation">;</span></span>
jest<span class="token punctuation">.</span><span class="token function">mock</span><span class="token punctuation">(</span><span class="token string">"./api/posts"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="gatsby-highlight-code-line"><span class="token function">test</span><span class="token punctuation">(</span><span class="token string">"We show a list of posts"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">  <span class="token keyword">const</span> <span class="token punctuation">{</span> getByText <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Index</span></span> <span class="token punctuation">/></span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">  <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">getByText</span><span class="token punctuation">(</span><span class="token string">"Loading..."</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBeInTheDocument</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span></code></pre></div>
<p>This was the first step. Now we need to make sure our async method gets called
correctly:</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="language-jsx"><code class="language-jsx"><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">"react"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> render <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"@testing-library/react"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> Index <span class="token keyword">from</span> <span class="token string">"./Index"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string">"jest-dom/extend-expect"</span><span class="token punctuation">;</span>
<span class="gatsby-highlight-code-line"><span class="token keyword">import</span> <span class="token punctuation">{</span> fetchPosts <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./api/posts"</span><span class="token punctuation">;</span></span>
jest<span class="token punctuation">.</span><span class="token function">mock</span><span class="token punctuation">(</span><span class="token string">"./api/posts"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">test</span><span class="token punctuation">(</span><span class="token string">"We show a list of posts"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> getByText <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Index</span></span> <span class="token punctuation">/></span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">getByText</span><span class="token punctuation">(</span><span class="token string">"Loading..."</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBeInTheDocument</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="gatsby-highlight-code-line">  <span class="token function">expect</span><span class="token punctuation">(</span>fetchPosts<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toHaveBeenCalledTimes</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">  <span class="token function">expect</span><span class="token punctuation">(</span>fetchPosts<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toHaveBeenCalledWith</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>We're testing that <code class="language-text">fetchPosts</code> has been called once and with no arguments. Note
that, since we're using <code class="language-text">jest.mock</code>, <code class="language-text">fetchPosts</code> is not going to be the method
we have in our codebase but a
<a href="https://jestjs.io/docs/en/mock-function-api" target="_blank" rel="nofollow noopener noreferrer">mock function</a>.</p>
<p>OK, we're almost there. All is left to do is to return some data from
<code class="language-text">fetchPosts</code> and verify it appears in the DOM. This is exactly what we're going
to do next:</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="language-jsx"><code class="language-jsx"><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">"react"</span><span class="token punctuation">;</span>
<span class="gatsby-highlight-code-line"><span class="token keyword">import</span> <span class="token punctuation">{</span> render<span class="token punctuation">,</span> wait <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"@testing-library/react"</span><span class="token punctuation">;</span></span><span class="token keyword">import</span> Index <span class="token keyword">from</span> <span class="token string">"./Index"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string">"jest-dom/extend-expect"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> fetchPosts <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./api/posts"</span><span class="token punctuation">;</span>

jest<span class="token punctuation">.</span><span class="token function">mock</span><span class="token punctuation">(</span><span class="token string">"./api/posts"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="gatsby-highlight-code-line"><span class="token function">test</span><span class="token punctuation">(</span><span class="token string">"We show a list of posts"</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">  <span class="token keyword">const</span> posts <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">{</span> id<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> title<span class="token punctuation">:</span> <span class="token string">"My post"</span><span class="token punctuation">,</span> url<span class="token punctuation">:</span> <span class="token string">"/1"</span> <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">  fetchPosts<span class="token punctuation">.</span><span class="token function">mockResolvedValueOnce</span><span class="token punctuation">(</span>posts<span class="token punctuation">)</span><span class="token punctuation">;</span></span>  <span class="token keyword">const</span> <span class="token punctuation">{</span> getByText <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Index</span></span> <span class="token punctuation">/></span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">getByText</span><span class="token punctuation">(</span><span class="token string">"Loading..."</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBeInTheDocument</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>fetchPosts<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toHaveBeenCalledTimes</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>fetchPosts<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toHaveBeenCalledWith</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="gatsby-highlight-code-line">  <span class="token keyword">await</span> <span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">getByText</span><span class="token punctuation">(</span><span class="token string">"My Posts"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBeInTheDocument</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">  posts<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">post</span> <span class="token operator">=></span> <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">getByText</span><span class="token punctuation">(</span>post<span class="token punctuation">.</span>title<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBeInTheDocument</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>And that's it! We're returning some fake values using <code class="language-text">mockResolvedValueOnce</code>.
We then wait for the async method to resolve and for <code class="language-text">Index</code> to rerender. To do
that we use the <code class="language-text">wait</code> method while checking that the title is rendered. After
that we go post-by-post and make sure the title is on the page.</p>
<hr>
<p>If you wanted to test that errors are rendered correctly it's just a matter of
changing the mock:</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="language-jsx"><code class="language-jsx"><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">"react"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> render<span class="token punctuation">,</span> wait <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"@testing-library/react"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> Index <span class="token keyword">from</span> <span class="token string">"./Index"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string">"jest-dom/extend-expect"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> fetchPosts <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./api/posts"</span><span class="token punctuation">;</span>

jest<span class="token punctuation">.</span><span class="token function">mock</span><span class="token punctuation">(</span><span class="token string">"./api/posts"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="gatsby-highlight-code-line"><span class="token function">test</span><span class="token punctuation">(</span><span class="token string">"We show an error message on failures"</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">  fetchPosts<span class="token punctuation">.</span><span class="token function">mockRejectedValueOnce</span><span class="token punctuation">(</span><span class="token string">"Error!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>  <span class="token keyword">const</span> <span class="token punctuation">{</span> getByText <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Index</span></span> <span class="token punctuation">/></span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">getByText</span><span class="token punctuation">(</span><span class="token string">"Loading..."</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBeInTheDocument</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>fetchPosts<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toHaveBeenCalledTimes</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>fetchPosts<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toHaveBeenCalledWith</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="gatsby-highlight-code-line">  <span class="token keyword">await</span> <span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span></span><span class="gatsby-highlight-code-line">    <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">getByText</span><span class="token punctuation">(</span><span class="token string">"Something went wrong."</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBeInTheDocument</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line">  <span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<hr>
<p>To recap, these are the steps to test an asynchronous method:</p>
<ol>
<li>Mock the method with
<a href="https://jestjs.io/docs/en/jest-object#jestmockmodulename-factory-options" target="_blank" rel="nofollow noopener noreferrer"><code class="language-text">jest.mock</code></a>
and make it resolve to some data;</li>
<li>Test the loading state;</li>
<li>Test that the async method got called correctly;</li>
<li>Test that the component rendered the data correctly.</li>
</ol></div></article><footer class="blog-post__Footer-sc-7gkdnd-1 dFUOyp">Would you like to have a civil discussion about this post? Hit me up on<!-- --> <a href="https://twitter.com/Gpx" target="_blank" rel="noopener noreferrer">twitter</a>.</footer></div><div class="footer__Container-sc-1abtvul-0 gyqfWo"><div class="footer__Content-sc-1abtvul-1 ddOZgs"><a href="/">Home</a>·<a href="/rss.xml">RSS</a>·<a href="https://twitter.com/Gpx" target="_blank" rel="noopener noreferrer">Twitter</a>·<a href="https://github.com/Gpx" target="_blank" rel="noopener noreferrer">GitHub</a></div><div class="footer__Copy-sc-1abtvul-2 ioFzeH">© 2014–<!-- -->2019<!-- --> Giorgio Polvara</div></div></div></div><script>
  
  
  if(true) {
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  }
  if (typeof ga === "function") {
    ga('create', 'UA-40681255-1', 'auto', {});
      
      
      
      }
      </script><script id="gatsby-script-loader">/*<![CDATA[*/window.page={"componentChunkName":"component---src-templates-blog-post-js","jsonName":"posts-how-to-test-asynchronous-methods-bbc","path":"/posts/how-to-test-asynchronous-methods/"};window.dataPath="726/path---posts-how-to-test-asynchronous-methods-bbc-b9b-jVaooB9j2Lq1FOyVwEgTHZK1IdI";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"app":["/app-8f0c61b713fc20007cc1.js"],"component---src-templates-blog-post-js":["/component---src-templates-blog-post-js-55aa70a957a750bead14.js"],"component---src-pages-index-js":["/component---src-pages-index-js-bf14a15347dd6c903ea1.js"],"pages-manifest":["/pages-manifest-a83c47475d73541df4b5.js"]};/*]]>*/</script><script src="/component---src-templates-blog-post-js-55aa70a957a750bead14.js" async=""></script><script src="/1-028385e9f855bc3dfe2e.js" async=""></script><script src="/styles-f1e3bcc8236c344d8830.js" async=""></script><script src="/app-8f0c61b713fc20007cc1.js" async=""></script><script src="/webpack-runtime-abed6febe877bdf6f217.js" async=""></script></body></html>