<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/styles.835962e22f0584898860.css">*,:after,:before{box-sizing:border-box}::selection,:not(pre) code[class*=language-]::selection{background:rgba(3,169,244,.2)}html{font-size:19px}body{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol;color:#333;line-height:1.5;margin:0}a{text-decoration:none;color:currentColor}code[class*=language-],pre[class*=language-]{font-family:Ubuntu Mono,monospace;font-size:.9em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}code[class*=language-]::selection,code[class*=language-] ::selection,pre[class*=language-]::selection,pre[class*=language-] ::selection{background:hsla(0,0%,100%,.13)}pre[class*=language-]{padding:1em;margin:0 0 .5em;overflow:auto}:not(pre)>code[class*=language-],pre[class*=language-]{background:#1e272e;border-radius:0 0 .5em .5em;color:#d2dae2}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal;background:rgba(0,0,0,.07);color:inherit}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#808e9b;font-style:italic}.token.punctuation{color:#808e9b}.namespace{color:red;background:red}.token.boolean,.token.constant,.token.deleted,.token.number,.token.property,.token.symbol,.token.tag{color:#ffa801}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string{color:#0be881}.language-css .token.string,.style .token.string,.token.entity,.token.operator,.token.url{color:#ffd32a}.token.atrule,.token.attr-value,.token.keyword{color:#ef5777}.token.class-name,.token.function{color:#0fbcf9}.token.important,.token.regex,.token.variable{color:#0be881}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}.gatsby-highlight-code-line{background:#2f3d48;display:block;margin-right:-1em;margin-left:-1em;padding-right:1em;padding-left:.75em;border-left:.25em solid #575fcf}.gatsby-highlight:before{content:attr(data-language);display:block;padding:.3em 1em;font-size:.9em;text-transform:uppercase;text-align:right;background-image:linear-gradient(90deg,#7986cb,#3f51b5);color:#fff;font-family:Ubuntu Mono,monospace;border-radius:.5em .5em 0 0}.gatsby-highlight[data-language=html]:before{background-image:linear-gradient(90deg,#ffb74d,#ff9800)}.gatsby-highlight[data-language=text]:before{content:" ";white-space:pre;background-image:linear-gradient(90deg,#dce775,#cddc39)}.gatsby-highlight{border-radius:.5em;box-shadow:2px 2px 3px 2px rgba(0,0,0,.2);margin:2em 0}article{margin-bottom:4em;-webkit-hyphens:auto;-ms-hyphens:auto;hyphens:auto;hyphenate-limit-chars:6 3 2;hyphenate-limit-lines:2;hyphenate-limit-last:always;-webkit-text-decoration-skip:ink;text-decoration-skip-ink:auto}article h1{font-size:2rem;margin:1.5em 0;text-align:center;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}article h2{text-align:left;font-size:1.3rem;margin:2em 0 1em}article p:first-child:first-line{font-weight:600}article a{text-decoration:underline}article figure{margin:auto auto 3em;text-align:center}article img{max-width:100%}article figcaption{text-align:center;font-style:italic}hr{border:none;border-radius:50%;margin:2em auto}hr,hr:after,hr:before{height:3px;width:3px;background:rgba(0,0,0,.67)}hr:after,hr:before{position:absolute;content:"";display:inline-block;border-radius:50%;padding:0}hr:before{transform:translateX(-1em)}hr:after{transform:translateX(1em)}article .highlight{text-align:left;-webkit-hyphens:initial;-ms-hyphens:initial;hyphens:manual;font-size:1.3em;color:#666;margin:1.7em;font-weight:100;padding-bottom:.5em;border-bottom:3px solid #3f51b5}article ul{text-align:left;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}article li{margin-bottom:.5em}details.tldr{border:1px solid rgba(0,0,0,.2);padding:.4em 1em;margin-bottom:4rem}details summary{cursor:pointer}twitter-widget{margin:2em auto!important}blockquote{text-align:left;-webkit-hyphens:initial;-ms-hyphens:initial;hyphens:manual;margin:2em auto;max-width:80%;font-size:1.2em;font-style:italic}blockquote p:first-child:first-line{font-weight:400}</style><meta name="generator" content="Gatsby 2.20.23"/><title data-react-helmet="true">Mind the Gap when upgrading to HTTP/2</title><meta data-react-helmet="true" property="og:title" content="Mind the Gap when upgrading to HTTP/2"/><meta data-react-helmet="true" property="og:type" content="article"/><meta data-react-helmet="true" property="og:url" content="https://www.polvara.me/posts/mind-the-gap-when-upgrading-to-http-2/"/><meta data-react-helmet="true" property="og:image" content="https://www.polvara.meundefined"/><style data-styled="" data-styled-version="5.1.0">.fscSeJ{display:block;max-width:500px;margin:auto;margin-top:3em;box-shadow:2px 2px 3px 2px #0003;padding:2em 2.5em;text-align:center;-webkit-transition:-webkit-transform 0.2s;-webkit-transition:transform 0.2s;transition:transform 0.2s;border-radius:6px;}/*!sc*/
data-styled.g1[id="newsletter-form__Card-a2ms4a-0"]{content:"fscSeJ,"}/*!sc*/
.eyKXbm{color:red;}/*!sc*/
data-styled.g2[id="newsletter-form__Button-a2ms4a-1"]{content:"eyKXbm,"}/*!sc*/
.KHPza{margin:0;font-size:1.6em;font-weight:500;line-height:1;}/*!sc*/
data-styled.g4[id="newsletter-form__Title-a2ms4a-3"]{content:"KHPza,"}/*!sc*/
.dYhHPN{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;margin-top:2em;}/*!sc*/
.dYhHPN label{text-align:left;margin-bottom:0.3em;}/*!sc*/
.dYhHPN [type="email"]{font-size:1.3em;border:1px solid #333;padding:0.3em 0.6em;border-radius:6px;margin-bottom:0.5em;}/*!sc*/
.dYhHPN [type="submit"]{background:#3a6;border:none;font-size:1.3em;padding:0.6em;color:#fff;text-shadow:1px 0 1px #0004;border-radius:6px;cursor:pointer;}/*!sc*/
data-styled.g6[id="newsletter-form__InputGroup-a2ms4a-5"]{content:"dYhHPN,"}/*!sc*/
.jBIpkR{margin-top:4em;padding:3em 0.5em;text-align:right;background:#3a6;color:#fff;text-shadow:1px 0 1px #0004;}/*!sc*/
data-styled.g7[id="footer__Container-sc-1abtvul-0"]{content:"jBIpkR,"}/*!sc*/
.ihWmWm{max-width:calc(65 * 9px);margin:auto;}/*!sc*/
.ihWmWm > *{margin:0.7em;}/*!sc*/
.ihWmWm > *:first-child{margin-left:0;}/*!sc*/
.ihWmWm > *:last-child{margin-right:0;}/*!sc*/
data-styled.g8[id="footer__Content-sc-1abtvul-1"]{content:"ihWmWm,"}/*!sc*/
.bcrfyt{max-width:calc(65 * 9px);margin:auto;font-size:0.85em;margin-top:1em;}/*!sc*/
data-styled.g9[id="footer__Copy-sc-1abtvul-2"]{content:"bcrfyt,"}/*!sc*/
.kWVCUY{padding:0 0.5em;max-width:calc(65 * 9px);margin:auto;}/*!sc*/
data-styled.g10[id="layout__Container-sc-4dh0yk-0"]{content:"kWVCUY,"}/*!sc*/
.fsQVfs{display:block;font-weight:500;font-size:1.5rem;text-align:center;padding:0.5em 0;color:#fff;text-shadow:1px 0 1px #0004;-webkit-text-decoration:none;text-decoration:none;width:100%;background:#3a6;}/*!sc*/
data-styled.g19[id="post-header__Title-sc-1okepgc-0"]{content:"fsQVfs,"}/*!sc*/
.jOkvKZ{display:block;font-size:0.45em;font-weight:400;color:#666;margin-top:0.5em;}/*!sc*/
data-styled.g20[id="blog-post__Meta-sc-7gkdnd-0"]{content:"jOkvKZ,"}/*!sc*/
.duvUWk{font-size:0.85rem;text-align:center;margin-bottom:3rem;padding:0.5em 0;background:#e8eaf6;}/*!sc*/
.duvUWk a{-webkit-text-decoration:underline;text-decoration:underline;}/*!sc*/
data-styled.g21[id="blog-post__Footer-sc-7gkdnd-1"]{content:"duvUWk,"}/*!sc*/
</style><link rel="preload" as="font" type="font/woff2" crossorigin="anonymous" href="/google-fonts/s/ubuntumono/v9/KFOjCneDtsqEr0keqCMhbCc6CsQ.woff2"/><style type="text/css">@font-face{font-family:'Ubuntu Mono';font-style:normal;font-weight:400;src:local('Ubuntu Mono'),local('UbuntuMono-Regular'),url(/google-fonts/s/ubuntumono/v9/KFOjCneDtsqEr0keqCMhbCc6CsQ.woff2) format('woff2'),url(/google-fonts/s/ubuntumono/v9/KFOjCneDtsqEr0keqCMhbCc6CsI.woff) format('woff');font-display: swap;}</style><link rel="preconnect dns-prefetch" href="https://www.google-analytics.com"/><link rel="alternate" type="application/rss+xml" href="/rss.xml"/><link as="script" rel="preload" href="/webpack-runtime-f44f25dcc5bf14113f2b.js"/><link as="script" rel="preload" href="/framework-c88d07efb40e009babfb.js"/><link as="script" rel="preload" href="/app-04a92f08d6fc44f9844d.js"/><link as="script" rel="preload" href="/styles-b729c27faa6284e9ff45.js"/><link as="script" rel="preload" href="/cd7d5f864fc9e15ed8adef086269b0aeff617554-f82161e91498ca4ce21b.js"/><link as="script" rel="preload" href="/component---src-templates-blog-post-js-bfc1dcca7d04c1f86347.js"/><link as="fetch" rel="preload" href="/page-data/posts/mind-the-gap-when-upgrading-to-http-2/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/app-data.json" crossorigin="anonymous"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><a class="post-header__Title-sc-1okepgc-0 fsQVfs" href="/">Giorgio Polvara&#x27;s Blog</a><div class="layout__Container-sc-4dh0yk-0 kWVCUY"><article lang="en"><h1><span>Mind the Gap when upgrading to HTTP/2</span><span class="blog-post__Meta-sc-7gkdnd-0 jOkvKZ">Approximately <!-- -->4<!-- --> min read</span></h1><figure><div class=" gatsby-image-wrapper" style="position:relative;overflow:hidden"><div aria-hidden="true" style="width:100%;padding-bottom:66.63461538461539%"></div><img aria-hidden="true" src="data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAANABQDASIAAhEBAxEB/8QAFwAAAwEAAAAAAAAAAAAAAAAAAAIEBf/EABYBAQEBAAAAAAAAAAAAAAAAAAEAAv/aAAwDAQACEAMQAAAByqJmcqBH/8QAGxAAAQQDAAAAAAAAAAAAAAAAEQABAhIDECH/2gAIAQEAAQUCaPclptVEIjX/xAAVEQEBAAAAAAAAAAAAAAAAAAAAEf/aAAgBAwEBPwFH/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPwE//8QAGRAAAgMBAAAAAAAAAAAAAAAAAAEgITEy/9oACAEBAAY/AqaFh1D/xAAZEAEBAQEBAQAAAAAAAAAAAAABEQAhMUH/2gAIAQEAAT8heLMyHgLzT9GqAfcsCZ7G+7//2gAMAwEAAgADAAAAEOff/8QAFhEBAQEAAAAAAAAAAAAAAAAAARAR/9oACAEDAQE/EAAyP//EABYRAQEBAAAAAAAAAAAAAAAAAAARAf/aAAgBAgEBPxDar//EABwQAQADAAIDAAAAAAAAAAAAAAEAESExQVFhkf/aAAgBAQABPxB7KGjaQsQDl+PuV8F8U5AyhQViw1hZ0y+li6ep/9k=" alt="" style="position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;object-position:center;opacity:1;transition-delay:500ms"/><noscript><picture><source type='image/webp' srcset="/static/f795dffe5603fdb30b6407753421ec59/026d6/cover.webp 1040w,
/static/f795dffe5603fdb30b6407753421ec59/ceab5/cover.webp 2048w" sizes="(max-width: 2048px) 100vw, 2048px" /><source srcset="/static/f795dffe5603fdb30b6407753421ec59/8d4f6/cover.jpg 1040w,
/static/f795dffe5603fdb30b6407753421ec59/5dbbf/cover.jpg 2048w" sizes="(max-width: 2048px) 100vw, 2048px" /><img loading="lazy" sizes="(max-width: 2048px) 100vw, 2048px" srcset="/static/f795dffe5603fdb30b6407753421ec59/8d4f6/cover.jpg 1040w,
/static/f795dffe5603fdb30b6407753421ec59/5dbbf/cover.jpg 2048w" src="/static/f795dffe5603fdb30b6407753421ec59/5dbbf/cover.jpg" alt="" style="position:absolute;top:0;left:0;opacity:1;width:100%;height:100%;object-fit:cover;object-position:center"/></picture></noscript></div><figcaption><a href="https://unsplash.com/photos/KqVHRmHVwwM" target="_blank" rel="noopener noreferrer">Photo by <!-- -->Erez Attias</a></figcaption></figure><div><p>The web has been in great ferment in the last few years. HTML 5, ECMAScript 2015
and all the new landing features are making our beloved platform a great place
to be.</p>
<p>One of the most significant improvements is HTTP/2.</p>
<p>The <em>Hypertext Transfer Protocol</em> evolved a lot since its beginnings in 1989.
When Tim Berners-Lee and his team created the protocol, they needed only a few
features.</p>
<p>This first version was simple: it allowed only to perform GET requests and
receive HTML data. Over the years, the <a href="https://httpwg.github.io/" target="_blank" rel="nofollow noopener noreferrer">HTTP WG</a>
documented and updated the protocol bringing it to version 1.1.</p>
<p>Although most of the web runs on HTTP/1.1, this version has many issues.
Updating a protocol, especially if highly adopted, is not an easy task. For this
reason, developers had to create workarounds to many problems.</p>
<p>If you are a web developer you know most of them and chances are you’re using
them in your projects.</p>
<p>All those best practices are helpful but become counterproductive when used
alongside with HTTP/2. Let’s analyze them and see why is this the case.</p>
<h2>Domain Sharding</h2>
<p>When we start an HTTP/1.x request, a new TCP connection is created. Once the
request ends, we can reutilize the connection so we don’t have to create a new
one.</p>
<p>This mechanism was serving us well during the early web but, with the time, we
outgrew it. A web page is no longer one single HTML file; we require CSS,
JavaScript and images.</p>
<p>For this reason, browsers started handling a connection pool of TCP streams.
Modern browsers usually support six streams per host. This means that, if your
page requires six images, the browser can download them in parallel. As you can
imagine, it is a great performance boost.</p>
<p>Even so, with the average web page asking for 90+ resources, this is still not
enough. Many requests will wait in queue before getting served.</p>
<p>Developers created a workaround to this problem: <em>domain sharding</em>. If a
browsers’ limit is six TCP connections per host, we can put our assets on
different hosts. That is, if our domain is <em>example.com</em>, images can be hosted
at <em>images.example.com</em> and CSS files at <em>css.example.com</em>. In this way the
browser will open six parallel connections for your images and six for your CSS
files. Note that usually these subdomains are just CNAME DNS records that point
to the same IP address.</p>
<p>The browser will have to resolve each DNS name but you get a good performance
boost.</p>
<p><em>If you decide to upgrade to HTTP/2 you should disable domain sharding.</em></p>
<p>HTTP/2 creates only one TCP connection and uses it to the fullest extent. The
stream can provide full <a href="https://en.wikipedia.org/wiki/Multiplexing" target="_blank" rel="nofollow noopener noreferrer">multiplex</a>
support, both while sending and receiving. For this reason, clients no longer
need to initiate more TCP connections at the same time. However, if we host our
assets on different domains, the browser will have to create a new TCP
connection. This not only means more DNS requests. With HTTP/2 headers are sent
only when we first set them and when we want to change them, saving precious
bytes. Connecting to more than one host means sending the headers more than
once. Last, the client can prioritize the requests to receive the most important
data first. If we use domain sharding this option is less effective.</p>
<h2>Concatenation and Spriting</h2>
<p>When you make a HTTP request you wait, at a minimum, for a full roundtrip of
latency before you get the first data back. For the average webpage this means a
lot of extra loading time. One obvious piece of advice here is “Don’t make a
request unless you need it”. Another way to speed-up the loading process is to
join together the resources you need.</p>
<p>When you join text files, usually JavaScript and CSS, we say we concatenate
them.</p>
<p>On the other hand, for images, we generate an <em>image sprite</em>. That is, an image
that contains more images. Using CSS we can then display only the part of the
image we need.</p>
<p>Both techniques allow us to generate less requests. Instead of 20 separate CSS
files we load just one that contains all others.</p>
<p>There are also downsides. Your page may not need all the data you concatenate
resulting in a waste of bandwidth. Also, if one of your assets changes, you
force the user to invalidate the cache and download it again. Last, your
JavaScript and CSS files will not get executed until the browser has finished to
downloading them.</p>
<p>All in all, for many applications running over HTTP/1.x, concatenation and
spriting is a good solution.</p>
<p>However, this is not true for HTTP/2, since many small resources can be
downloaded in parallel. In this case, the downsides of concatenating exceed its
benefits.</p>
<p>Another feature in HTTP/2 is the ability for the server to push data to the
client. When this happens, the browser will simply store the data in its cache.
Later, when that resource is needed, it can be fetched from the cache. This
makes concatenating even less necessary. We can instruct the server to push all
these little assets, giving them priority.</p>
<h2>Conclusions</h2>
<p>HTTP/2
<a href="http://caniuse.com/#feat=http2" target="_blank" rel="nofollow noopener noreferrer">is currently supported by most web browsers</a>.
Although a decade will pass before the majority of the web upgrades to it. Even
so, you should plan your upgrade path now. The benefits you’ll get from it are
definitely worth it. Just remeber to question all the best practices you learned
through the years.</p></div></article><footer class="blog-post__Footer-sc-7gkdnd-1 duvUWk">Would you like to have a civil discussion about this post? Hit me up on<!-- --> <a href="https://twitter.com/Gpx" target="_blank" rel="noopener noreferrer">twitter</a>.</footer></div><div class="newsletter-form__Card-a2ms4a-0 fscSeJ"><h1 class="newsletter-form__Title-a2ms4a-3 KHPza">Subscribe to my newsletter</h1><div class="newsletter-form__Sub-a2ms4a-4 cocZZB">No spam. Unsubscribe when you want.</div><form action="https://buttondown.email/api/emails/embed-subscribe/gpx" method="post" target="popupwindow" class="newsletter-form__Form-a2ms4a-2 kvNPcB"><div class="newsletter-form__InputGroup-a2ms4a-5 dYhHPN"><label for="bd-email">Email</label><input type="email" name="email" id="bd-email" placeholder="Your email" required=""/><input type="submit" value="Subscribe" class="newsletter-form__Button-a2ms4a-1 eyKXbm"/></div><input type="hidden" value="1" name="embed"/></form></div><div class="footer__Container-sc-1abtvul-0 jBIpkR"><div class="footer__Content-sc-1abtvul-1 ihWmWm"><a href="/">Home</a>·<a href="/rss.xml">RSS</a>·<a href="https://twitter.com/Gpx" target="_blank" rel="noopener noreferrer">Twitter</a>·<a href="https://github.com/Gpx" target="_blank" rel="noopener noreferrer">GitHub</a></div><div class="footer__Copy-sc-1abtvul-2 bcrfyt">© 2014–<!-- -->2020<!-- --> Giorgio Polvara</div></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script>
  
  
  if(true) {
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  }
  if (typeof ga === "function") {
    ga('create', 'UA-40681255-1', 'auto', {});
      
      
      
      
      
      }</script><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/posts/mind-the-gap-when-upgrading-to-http-2/";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"app":["/app-04a92f08d6fc44f9844d.js"],"component---src-pages-index-js":["/component---src-pages-index-js-9e65936978fe9bd40e40.js"],"component---src-templates-blog-post-js":["/component---src-templates-blog-post-js-bfc1dcca7d04c1f86347.js"]};/*]]>*/</script><script src="/component---src-templates-blog-post-js-bfc1dcca7d04c1f86347.js" async=""></script><script src="/cd7d5f864fc9e15ed8adef086269b0aeff617554-f82161e91498ca4ce21b.js" async=""></script><script src="/styles-b729c27faa6284e9ff45.js" async=""></script><script src="/app-04a92f08d6fc44f9844d.js" async=""></script><script src="/framework-c88d07efb40e009babfb.js" async=""></script><script src="/webpack-runtime-f44f25dcc5bf14113f2b.js" async=""></script></body></html>